{% extends 'base.html' %}

{% block content %}
<div class="relative flex justify-center items-center">
    <img src="music_player.png" alt="" class="">
    <img src="music_button_1.png" alt="" class="absolute z-30 w-1/5 left-8 top-8 cursor-pointer" id="buttonImage">
    <img src="music_lp.png" alt="" class="absolute z-20 w-7/12 cursor-pointer" id="lpImage">
</div>

<!-- YouTube Player Container -->
<div id="player"></div>

<!-- Modal -->
<div class="modal close absolute w-screen h-screen z-[9999] flex justify-center items-center" id="modal">
    <div class="bg absolute w-screen h-screen bg-black/50"></div>
    <div class="card relative">
        <i class='bx bx-x text-3xl absolute top-5 right-9 cursor-pointer' onclick="closeModal()"></i>
        <img src="songs_link_new.png" class="w-96" alt="">
        <div class="input flex justify-center absolute top-[40%] left-[38%]">
            <input type="text" 
                   name="music" 
                   id="musicLink" 
                   class="absolute" 
                   placeholder="Enter Link Music...">
        </div>
        <div class="button absolute flex left-[50%] bottom-10">
            <button onclick="playMusic()" 
                class="absolute bg-slate-400 p-2 rounded-xl submit-btn">
            Submit
        </button>
        </div>
    </div>
</div>

<script>
    let player;
    const lpImage = document.getElementById('lpImage');
    const buttonImage = document.getElementById('buttonImage');
    const modal = document.getElementById('modal');
    const musicInput = document.getElementById('musicLink');

    // เพิ่ม YouTube API
    function loadYouTubeAPI() {
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }

    // สร้าง YouTube Player
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '0',
            width: '0',
            playerVars: {
                'autoplay': 0,
                'controls': 0,
                'playsinline': 1
            },
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerReady(event) {
        // Player is ready
        console.log('Player is ready');
    }

    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
            lpImage.classList.add('spin-animation');
        } else {
            lpImage.classList.remove('spin-animation');
        }
    }

    function getYouTubeVideoId(url) {
        const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[7].length == 11) ? match[7] : false;
    }

    function playMusic() {
        const videoUrl = musicInput.value.trim();
        const videoId = getYouTubeVideoId(videoUrl);
        
        if (videoId) {
            player.loadVideoById(videoId);
            closeModal();
        } else {
            alert('Please enter a valid YouTube URL');
        }
    }

    // Enter key handler for input field
    musicInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            playMusic();
        }
    });

    lpImage.addEventListener('click', () => {
        if (player && typeof player.getPlayerState === 'function') {
            if (player.getPlayerState() === YT.PlayerState.PLAYING) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        }
    });

    buttonImage.addEventListener('click', () => {
        modal.classList.remove('close');
    });

    function closeModal() {
        modal.classList.add('close');
    }

    // Load YouTube API when page loads
    loadYouTubeAPI();
</script>
{% endblock %}